<!doctype html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
		integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
	<title>CodingBlocks Slack Stats</title>

	<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
	<script>
		google.charts.load('current', { packages: ['corechart', 'line'] });

		function getLatestData(url = 'https://cbslackstats.z20.web.core.windows.net/general-member-count.json') {
			let request = new XMLHttpRequest();
			request.open('GET', url);
			request.responseType = 'text';
			request.onload = function () {
				let obj = JSON.parse(request.response);
				let updatedDateTime = new Date(obj.updated);
				setUpdatedMessage(updatedDateTime);
				let countByDate = obj["records"];
				drawCurveTypes(countByDate);
			};
			request.send();
		}

		function setUpdatedMessage(updatedDateTime) {
			let date = updatedDateTime.toDateString();
			let time = updatedDateTime.toLocaleTimeString();
			let age = Math.floor((Date.now() - updatedDateTime) / 1000 / 60);
			document.getElementById("updatedMessage").innerText = `Last updated on ${date} at ${time} (${age} minutes ago)`;
		}

		function drawCurveTypes(countByDate = null) {
			var data = new google.visualization.DataTable();
			data.addColumn('date', 'X');
			data.addColumn('number', 'Count');

			if (countByDate) {
				for (const [key, value] of Object.entries(countByDate)) {
					let dt = new Date(key);
					let count = parseInt(value);
					data.addRow([dt, count]);
				}
			}

			var options = {
				legend: { position: 'none' },
				hAxis: {
					format: 'MMM yyyy',
					slantedText: true,
					slantedTextAngle: 45
				},
				vAxis: {
					title: 'Number of members in General'
				},
			};

			var chart = new google.visualization.LineChart(document.getElementById('chart_div'));
			chart.draw(data, options);
		}
	</script>
</head>

<body class="bg-light" onload="getLatestData();">
	<div class="container my-3 p-3 text-center">
		<h1 class="display-4">CodingBlocks Slack Stats</h1>
		<div id="updatedMessage" class="">Last updated on 2021-01-30 at 15:30 UTC (23 minutes ago)</div>
		<a href="https://www.codingblocks.net/slack/" class="btn btn-primary btn-sm m-2" role="button">Join the
			Slack</a>
		<a href='https://cbslackstats.z20.web.core.windows.net/general-member-count.json'
			class="btn btn-primary btn-sm m-2" role="button">Raw Data</a>
		<a href='https://github.com/swharden/cb-slack-stats' class="btn btn-primary btn-sm m-2" role="button">Source
			Code</a>
		<div id="chart_div" class="border my-3" style="height: 500px;"></div>
	</div>
</body>

</html>